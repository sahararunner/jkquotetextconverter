<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Quote Text Converter</title>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .warning {
        color: red;
      }
      .hidden {
        display: none;
      }
      .gray {
        color: gray;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  </head>
  <body>
    <h1>Quote Text Converter</h1>
    <form id="quoteForm" onsubmit="return processFiles()">
      <label for="quote_file">Upload Quote (Excel):</label>
      <input type="file" id="quote_file" name="quote_file" accept=".xlsx"><br><br>

      <label for="product_list">Upload Product List (Excel):</label>
      <input type="file" id="product_list" name="product_list" accept=".xlsx"><br><br>

      <label for="color">Select Color:</label>
      <select id="color" name="color">
        <option value="">--Select Color--</option>
        <option value="A7">A7</option>
        <option value="B5">B5</option>
        <option value="B6">B6</option>
        <option value="B7">B7</option>
        <option value="B8">B8</option>
        <option value="CO66">CO66</option>
        <option value="E1">E1</option>
        <option value="E2">E2</option>
        <option value="E3">E3</option>
        <option value="H8">H8</option>
        <option value="H9">H9</option>
        <option value="J5">J5</option>
        <option value="K10">K10</option>
        <option value="K3">K3</option>
        <option value="K8">K8</option>
        <option value="M01">M01</option>
        <option value="S1">S1</option>
        <option value="S2">S2</option>
        <option value="S5">S5</option>
        <option value="S8">S8</option>
      </select><br><br>

      <input type="submit" value="Convert">
      <button type="button" onclick="restartForm()">Restart</button>
      <span id="warning" class="warning hidden">Please select a color</span><br><br>

      <label for="result">Result:</label><br>
      <textarea id="result" rows="10" cols="50" readonly></textarea><br>
      <span id="totalProducts" class="gray hidden">Total X products converted</span>
    </form>

    <script>
      function checkColorSelection() {
        const color = document.getElementById('color').value;
        if (!color) {
          document.getElementById('warning').classList.remove('hidden');
          return false;
        }
        document.getElementById('warning').classList.add('hidden');
        return true;
      }

      function restartForm() {
        document.getElementById('quote_file').value = '';
        document.getElementById('result').value = '';
        document.getElementById('totalProducts').classList.add('hidden');
        document.getElementById('warning').classList.add('hidden');
      }

      function processFiles() {
        if (!checkColorSelection()) return false;

        const quoteFile = document.getElementById('quote_file').files[0];
        const productListFile = document.getElementById('product_list').files[0];

        if (!quoteFile || !productListFile) {
          alert("Please upload both files.");
          return false;
        }

        const color = document.getElementById('color').value;

        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const quoteData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          const manufCodes = quoteData.slice(1, 301).map(row => row[3]); // Assuming Manuf. code is column D (index 3)

          console.log('Manufacturer Codes:', manufCodes);

          const reader2 = new FileReader();
          reader2.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const productList = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            console.log('Product List:', productList);

            const results = [];
            manufCodes.forEach(manufCode => {
              productList.forEach(row => {
                if (row[0] === color && row[1] === manufCode) {
                  const itemCode = row[2];
                  const existingItem = results.find(item => item.startsWith(itemCode));
                  if (existingItem) {
                    const index = results.indexOf(existingItem);
                    const qty = parseInt(existingItem.split('\t')[1]) + 1;
                    results[index] = `${itemCode}\t${qty}`;
                  } else {
                    results.push(`${itemCode}\t1`);
                  }
                }
              });
            });

            console.log('Results:', results);
            document.getElementById('result').value = results.join('\n');

            const totalQty = results.reduce((total, item) => total + parseInt(item.split('\t')[1]), 0);
            document.getElementById('totalProducts').textContent = `Total ${totalQty} products converted`;
            document.getElementById('totalProducts').classList.remove('hidden');
          };
          reader2.readAsArrayBuffer(productListFile);
        };
        reader.readAsArrayBuffer(quoteFile);

        return false;
      }
    </script>
  </body>
</html>
